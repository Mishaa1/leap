---
title: "REDCap API"
author: "Shan"
date: '2019-05-24'
output: html_document
---

# Three REDCap API packages testing 
## 1-Package REDCapR
```{r}
library(magrittr)
library(REDCapR)
uri='https://rc.bcchr.ca/redcap_demo/api/'
token='3405DC778F3D3B9639E53C1A3394EC09'

# Export all records from Porject: `REDCAP API TEST`
all_records_REDCapR <- REDCapR::redcap_read(redcap_uri=uri, token=token)$data

# metadata 
metadata_REDCapR <- REDCapR::redcap_metadata_read(redcap_uri=uri, token=token)

# select three columns
project_REDCapR <- REDCapR::redcap_project$new(redcap_uri=uri, token=token)
ds_three_columns  <- project_REDCapR$read(fields=c("record_id", "age", "bmi"))$data

# filters example
all_records_REDCapR[all_records_REDCapR$age < 50 & all_records_REDCapR$bmi > 20, ]

# count example
all_records_REDCapR %>% dplyr::count(feel)
```

## 2-Package redcapAPI
```{r}
library(redcapAPI)
project_redcapAPI <- redcapAPI::redcapConnection(
  url='https://rc.bcchr.ca/redcap_demo/api/',
  token='3405DC778F3D3B9639E53C1A3394EC09'
)

# Export all records from Porject: `REDCAP API TEST`
all_records_redcapAPI <- redcapAPI::exportRecords(project_redcapAPI)

# metadata
metadata_redcapAPI <- redcapAPI::exportMetaData(project_redcapAPI)

# filer example
all_records_redcapAPI %>%
  dplyr::filter(grade == 1, stage == "II") 

# count example
all_records_redcapAPI %>% 
  dplyr::count(feel, stage)
```

## 3-Package RCurl
### Export metadata of a project
```{r}
#!/usr/bin/env Rscript
library(RCurl)
result <- postForm(
    uri='https://rc.bcchr.ca/redcap_demo/api/',
    token='3405DC778F3D3B9639E53C1A3394EC09',
    content='metadata',
    format='csv',
    returnFormat='json',
    'fields[0]'='my_first_instrument_complete',
    'forms[0]'='my_first_instrument'
)

md <- textConnection(result)
metadata <- read.csv(md, stringsAsFactors = FALSE)
metadata
```


### Export all records from Porject: `REDCAP API TEST`
```{r}
#!/usr/bin/env Rscript
library(RCurl)
result <- postForm(
    uri='https://rc.bcchr.ca/redcap_demo/api/',
    token='3405DC778F3D3B9639E53C1A3394EC09',
    content='record',
    format='csv',
    type='flat',
    'records[0]'='1',
    'records[1]'='2',
    'records[2]'='3',
    'records[3]'='4',
    'records[4]'='5',
    'records[5]'='6',
    'records[6]'='7',
    'records[7]'='8',
    'records[8]'='9',
    'records[9]'='10',
    'records[10]'='11',
    'records[11]'='12',
    'records[12]'='13',
    'records[13]'='14',
    'records[14]'='15',
    'records[15]'='16',
    'records[16]'='17',
    'records[17]'='18',
    'records[18]'='19',
    'records[19]'='20',
    'records[20]'='21',
    'records[21]'='22',
    'records[22]'='23',
    'records[23]'='24',
    'records[24]'='25',
    'records[25]'='26',
    'records[26]'='27',
    'records[27]'='28',
    'records[28]'='29',
    'records[29]'='30',
    'records[30]'='31',
    'records[31]'='32',
    'records[32]'='33',
    'records[33]'='34',
    'records[34]'='35',
    'records[35]'='36',
    'records[36]'='37',
    'records[37]'='38',
    'records[38]'='39',
    'records[39]'='40',
    'records[40]'='41',
    'records[41]'='42',
    'records[42]'='43',
    'records[43]'='44',
    'records[44]'='45',
    'records[45]'='46',
    'records[46]'='47',
    'records[47]'='48',
    'records[48]'='49',
    'records[49]'='50',
    'records[50]'='51',
    'records[51]'='52',
    'records[52]'='53',
    'records[53]'='54',
    'records[54]'='55',
    'records[55]'='56',
    'records[56]'='57',
    'records[57]'='58',
    'records[58]'='59',
    'records[59]'='60',
    'records[60]'='61',
    'records[61]'='62',
    'records[62]'='63',
    'records[63]'='64',
    'records[64]'='65',
    'records[65]'='66',
    'records[66]'='67',
    'records[67]'='68',
    'records[68]'='69',
    'records[69]'='70',
    'records[70]'='71',
    'records[71]'='72',
    'records[72]'='73',
    'records[73]'='74',
    'records[74]'='75',
    'records[75]'='76',
    'records[76]'='77',
    'records[77]'='78',
    'records[78]'='79',
    'records[79]'='80',
    'records[80]'='81',
    'records[81]'='82',
    'records[82]'='83',
    'records[83]'='84',
    'records[84]'='85',
    'records[85]'='86',
    'records[86]'='87',
    'records[87]'='88',
    'records[88]'='89',
    'records[89]'='90',
    'records[90]'='91',
    'records[91]'='92',
    'records[92]'='93',
    'records[93]'='94',
    'records[94]'='95',
    'records[95]'='96',
    'records[96]'='97',
    'records[97]'='98',
    'records[98]'='99',
    'records[99]'='100',
    'fields[0]'='my_first_instrument_complete',
    'forms[0]'='my_first_instrument',
    rawOrLabel='raw',
    rawOrLabelHeaders='raw',
    exportCheckboxLabel='false',
    exportSurveyFields='false',
    exportDataAccessGroups='false',
    returnFormat='json'
)

res <- textConnection(result)
toy_data <- read.csv(res, stringsAsFactors = FALSE)
```
# Filters
Use `==` to filter for equalities.
```{r}
toy_data %>%
  dplyr::filter(grade == 1)
```

Use `&` or `,` to separate additional conditions.

```{r}
toy_data %>%
  dplyr::filter(grade == 1, stage == "II")
```

```{r}
toy_data %>%
  dplyr::filter(grade == 1 & stage == "II")
```

Pipe to `nrow()` to get number of cases.

```{r}
toy_data %>%
  dplyr::filter(grade == 1, stage == "II") %>% 
  nrow()
```

We can use inequalities for numeric variables (type `dbl`).

```{r}
toy_data %>% 
  dplyr::filter(age < 50, bmi >= 20)
```

# Counts

We can tabulate counts for every level of a factor.

```{r}
toy_data %>% 
  dplyr::count(feel)
```

Bivariate counts also work.

```{r}
toy_data %>% 
  dplyr::count(feel, stage)
```